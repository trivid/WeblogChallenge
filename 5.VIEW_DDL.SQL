
DROP VIEW IF EXISTS VWEI02.V_WEBLOG_SESSIONS;
CREATE VIEW VWEI02.V_WEBLOG_SESSIONS AS
SELECT
  SESSION_ID_10 AS SESSION_ID
, REQUEST_TIME				
, elb						
, client_port				
, backend_port				
, request_processing_time	
, backend_processing_time	
, response_processing_time	
, elb_status_code			
, backend_status_code		
, received_bytes			
, sent_bytes				
, request					
, user_agent				
, ssl_cipher				
, ssl_protocol
FROM VWEI02.WEBLOG_SESSIONS;

DROP VIEW IF EXISTS VWEI02.AVERAGE_SESSION_TIME_IN_SECONDS;
CREATE VIEW VWEI02.AVERAGE_SESSION_TIME_IN_SECONDS AS
SELECT AVG(SESSION_TIME) AS AVERAGE_SESSION_TIME_IN_SECONDS FROM (
SELECT 
SESSION_ID
, UNIX_TIMESTAMP(MAX(REQUEST_TIME)) - UNIX_TIMESTAMP(MIN(REQUEST_TIME)) AS SESSION_TIME
FROM VWEI02.V_WEBLOG_SESSIONS
GROUP BY SESSION_ID) ST;

DROP VIEW IF EXISTS VWEI02.UNIQUE_URL_VISITS_PER_SESSION;
CREATE VIEW VWEI02.UNIQUE_URL_VISITS_PER_SESSION AS
SELECT 
SESSION_ID
, COUNT(DISTINCT request) AS UNIQUE_URL_VISITS_PER_SESSION
FROM VWEI02.V_WEBLOG_SESSIONS
GROUP BY SESSION_ID;

DROP VIEW IF EXISTS VWEI02.MOST_ENGAGED_USER;
CREATE VIEW VWEI02.MOST_ENGAGED_USER AS
SELECT 
  CLIENT_PORT
, SUM(SESSION_TIME) AS TOTAL_SESSION_TIME
, COUNT(SESSION_ID) AS NUM_SESSIONS
FROM
(
  SELECT
	SESSION_ID
  , CLIENT_PORT
  , UNIX_TIMESTAMP(MAX(REQUEST_TIME)) - UNIX_TIMESTAMP(MIN(REQUEST_TIME)) AS SESSION_TIME
  FROM VWEI02.V_WEBLOG_SESSIONS
  GROUP BY SESSION_ID, CLIENT_PORT
) F
GROUP BY CLIENT_PORT
ORDER BY TOTAL_SESSION_TIME DESC LIMIT 1;

