DROP TABLE IF EXISTS VWEI02.WEBLOG_SESSIONIZE_SETP1;
CREATE TABLE VWEI02.WEBLOG_SESSIONIZE_SETP1 
(
  CLIENT_PORT	VARCHAR(50)
, REQUEST_TIME	TIMESTAMP
, DIFFERENCE	BIGINT
)
COMMENT 'Weblog Sessionization Step 1 where the difference in seconds between each request is calculated for each client.'
STORED AS AVRO;

INSERT OVERWRITE TABLE VWEI02.WEBLOG_SESSIONIZE_SETP1
SELECT 
  CLIENT_PORT
, REQUEST_TIME
, cast(REQUEST_TIME as bigint) - cast(FIRST_VALUE(REQUEST_TIME) OVER (PARTITION BY CLIENT_PORT ORDER BY REQUEST_TIME ROWS BETWEEN 1 PRECEDING AND CURRENT ROW ) as bigint) AS DIFFERENCE
FROM VWEI02.WEBLOG 
group by REQUEST_TIME, client_port;